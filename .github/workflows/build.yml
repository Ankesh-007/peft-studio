name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Verify backend structure
      run: |
        cd backend
        python -c "import services; import database; import config; print('Backend imports successful')"
        
    - name: Check for syntax errors
      run: |
        cd backend
        python -m py_compile main.py
        python -m py_compile database.py
        python -m py_compile config.py
        find services -name "*.py" -exec python -m py_compile {} \;
        
    - name: Create backend artifact
      run: |
        mkdir -p backend-dist
        cp -r backend/* backend-dist/
        
    - name: Upload backend artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-build
        path: backend-dist/
        retention-days: 7

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build frontend
      run: npm run build
      
    - name: Verify build output
      run: |
        if [ ! -d "dist" ]; then
          echo "Error: dist directory not created"
          exit 1
        fi
        if [ ! -f "dist/index.html" ]; then
          echo "Error: index.html not found in dist"
          exit 1
        fi
        echo "Frontend build successful"
        ls -la dist/
        
    - name: Upload frontend artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: dist/
        retention-days: 7

  build-electron-ubuntu:
    name: Build Electron (Ubuntu)
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Download frontend build
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: dist/
        
    - name: Download backend build
      uses: actions/download-artifact@v4
      with:
        name: backend-build
        path: backend/
        
    - name: Build Electron app
      run: npm run electron:build -- --linux
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Verify Electron build
      run: |
        if [ ! -d "release" ]; then
          echo "Error: release directory not created"
          exit 1
        fi
        echo "Electron build successful"
        ls -la release/
        
    - name: Upload Electron artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-linux
        path: release/*.{AppImage,deb}
        retention-days: 7
        if-no-files-found: warn

  build-electron-macos:
    name: Build Electron (macOS)
    runs-on: macos-latest
    needs: [build-backend, build-frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Download frontend build
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: dist/
        
    - name: Download backend build
      uses: actions/download-artifact@v4
      with:
        name: backend-build
        path: backend/
        
    - name: Build Electron app
      run: npm run electron:build -- --mac
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Verify Electron build
      run: |
        if [ ! -d "release" ]; then
          echo "Error: release directory not created"
          exit 1
        fi
        echo "Electron build successful"
        ls -la release/
        
    - name: Upload Electron artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-macos
        path: release/*.{dmg,zip}
        retention-days: 7
        if-no-files-found: warn

  build-electron-windows:
    name: Build Electron (Windows)
    runs-on: windows-latest
    needs: [build-backend, build-frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Download frontend build
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: dist/
        
    - name: Download backend build
      uses: actions/download-artifact@v4
      with:
        name: backend-build
        path: backend/
        
    - name: Build Electron app
      run: npm run electron:build -- --win
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Verify Electron build
      run: |
        if (!(Test-Path "release")) {
          Write-Error "Error: release directory not created"
          exit 1
        }
        Write-Output "Electron build successful"
        Get-ChildItem release/
      shell: pwsh
        
    - name: Upload Electron artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-windows
        path: release/*.exe
        retention-days: 7
        if-no-files-found: warn

  verify-all-builds:
    name: Verify All Builds
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, build-electron-ubuntu, build-electron-macos, build-electron-windows]
    if: always()
    
    steps:
    - name: Check build results
      run: |
        echo "Build Backend: ${{ needs.build-backend.result }}"
        echo "Build Frontend: ${{ needs.build-frontend.result }}"
        echo "Build Electron Ubuntu: ${{ needs.build-electron-ubuntu.result }}"
        echo "Build Electron macOS: ${{ needs.build-electron-macos.result }}"
        echo "Build Electron Windows: ${{ needs.build-electron-windows.result }}"
        
        if [[ "${{ needs.build-backend.result }}" != "success" ]] || \
           [[ "${{ needs.build-frontend.result }}" != "success" ]] || \
           [[ "${{ needs.build-electron-ubuntu.result }}" != "success" ]] || \
           [[ "${{ needs.build-electron-macos.result }}" != "success" ]] || \
           [[ "${{ needs.build-electron-windows.result }}" != "success" ]]; then
          echo "❌ One or more builds failed"
          exit 1
        fi
        
        echo "✅ All builds completed successfully!"
        
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-builds/
        
    - name: List all build artifacts
      run: |
        echo "All build artifacts:"
        find all-builds -type f
        
    - name: Create build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Backend build: Success" >> $GITHUB_STEP_SUMMARY
        echo "✅ Frontend build: Success" >> $GITHUB_STEP_SUMMARY
        echo "✅ Electron (Ubuntu): Success" >> $GITHUB_STEP_SUMMARY
        echo "✅ Electron (macOS): Success" >> $GITHUB_STEP_SUMMARY
        echo "✅ Electron (Windows): Success" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All distribution packages are ready for release!" >> $GITHUB_STEP_SUMMARY
